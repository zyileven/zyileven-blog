---
title: '虚拟 DOM 与 DIFF 算法'
description: '虚拟 dom 与 diff 算法是 react 为了用来优化更新 dom 提出的一种技术'
pubDate: '2024-06-05'
heroImage: '/images/2024/6/5/v-dom.jpeg'
---

## 虚拟 DOM 与 diff 算法

### 虚拟 DOM

虚拟 DOM（Virtual DOM）是 React 用来提高性能和简化编程的一种技术。它是一个轻量级的 JavaScript 对象，是对实际 DOM 的抽象表示。每当应用的状态或数据发生变化时，React 首先更新虚拟 DOM，而不是直接操作真实 DOM。

#### 工作流程

1. **初始化渲染**：当组件首次渲染时，React 会创建一个虚拟 DOM 树，表示组件的当前状态。
2. **更新渲染**：当组件的状态或 props 发生变化时，React 会创建一个新的虚拟 DOM 树来表示更新后的状态。
3. **比较差异**：React 使用 diff 算法比较新旧虚拟 DOM 树，找出需要更新的部分。
4. **批量更新**：React 根据差异计算出最小的变更操作，并将这些操作应用到实际 DOM 中。

### Diff 算法

React 的 diff 算法（又称协调算法）是一个高效的算法，用于比较两棵虚拟 DOM 树，并找出它们之间的差异。这个算法的核心思想是尽可能减少对真实 DOM 的操作，以提高性能。

#### Diff 算法的核心步骤

1. **分层比较**：React 只比较同一层级的节点，而不跨层级比较。这意味着，如果一个节点的结构发生了变化，React 会先销毁整个子树，然后重新创建新的子树。
2. **节点类型判断**：如果两个节点类型不同，React 会直接替换旧节点及其子树。
3. 同类型节点比较：如果两个节点类型相同，React 会对比它们的属性和子节点：
   - **属性比较**：React 比较新旧虚拟 DOM 节点的属性，找出需要更新的属性。
   - **子节点比较**：React 通过唯一 key 属性来比较子节点，从而高效地处理节点的添加、删除和重新排序。

#### Key 属性

为了更高效地进行子节点比较，React 要求每个子节点都有一个唯一的 `key` 属性。`key` 用于标识每个节点，以便在更新时快速找到对应的节点，从而优化节点的更新操作。

考虑以下示例，其中展示了 React 如何通过 diff 算法来更新虚拟 DOM：

```jsx
// 变更前
<ul>
  <li key="1">Item 1</li>
  <li key="2">Item 2</li>
  <li key="3">Item 3</li>
</ul>
// 更新后
<ul>
  <li key="1">Item 1</li>
  <li key="3">Item 3</li>
  <li key="4">Item 4</li>
</ul>
```

在这个例子中，React 会比较新旧虚拟 DOM：

- `Item 1` 没有变化。
- `Item 2` 被移除。
- `Item 3` 位置改变，但由于 `key` 相同，React 识别为同一个节点，并且保持其内容。
- 新增 `Item 4`。

React 通过 `key` 属性识别节点的变化，从而高效地更新实际 DOM。

### 总结

虚拟 DOM 和 diff 算法是 React 性能优化的关键技术。虚拟 DOM 使得 React 可以在内存中进行高效的 DOM 操作，而 diff 算法则确保了最小化对实际 DOM 的更新，从而提高应用的性能和响应速度。了解和掌握这些概念有助于深入理解 React 的工作原理，并在实际开发中更好地优化 React 应用。









